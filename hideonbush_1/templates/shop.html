<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Á∂†Ëâ≤ÈªûÊï∏ÂïÜÂüé - ÂõûÊî∂ÊèõÈªûÊï∏ÔºåÁ∂†Ëâ≤Êñ∞ÁîüÊ¥ª">
    <title>Á∂†Ëâ≤ÈªûÊï∏ÂïÜÂüé</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: rgb(0, 137, 123);
            --primary-light: rgba(0, 137, 123, 0.1);
            --primary-dark: rgb(0, 110, 99);
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --bg-gradient: linear-gradient(135deg, #f0f9f5 0%, #e6f7f3 100%);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.15);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-full: 50%;
            --transition-fast: 0.2s ease;
            --transition-base: 0.3s ease;
            --transition-smooth: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Arial', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: var(--shadow-md);
            border-bottom: 4px solid var(--primary-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            background: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .logo-text h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            color: var(--text-primary);
            margin-bottom: 0.2rem;
        }

        .logo-text p {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .points-display {
            text-align: center;
        }

        .points-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            font-weight: bold;
            color: var(--primary-color);
        }

        .points-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .cart-icon {
            position: relative;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color var(--transition-base);
        }

        .cart-icon:hover {
            color: var(--primary-color);
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--radius-full);
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0 4px;
        }

        /* Navigation */
        .nav {
            background: white;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 82px;
            z-index: 99;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            padding: 0 1rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-container::-webkit-scrollbar {
            display: none;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
            transition: all var(--transition-base);
            color: var(--text-secondary);
            white-space: nowrap;
            user-select: none;
        }

        .nav-item:hover {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .nav-item.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 200px);
        }

        /* Loading State */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            color: var(--primary-color);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary-color);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Category Filter */
        .category-filter {
            margin-bottom: 2rem;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid transparent;
            border-radius: 25px;
            background: white;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-md);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .category-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.3);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 300px), 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            transform: scaleX(0);
            transition: transform var(--transition-base);
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-image {
            text-align: center;
            font-size: 4rem;
            margin-bottom: 1rem;
            line-height: 1;
        }

        .product-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            margin-bottom: 1rem;
        }

        .star {
            color: #ffd700;
            font-size: 0.9rem;
        }

        .star.empty {
            color: #ddd;
        }

        .rating-value {
            margin-left: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .product-name {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
            color: var(--text-primary);
        }

        .product-description {
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            flex-grow: 1;
        }

        .product-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #f0f0f0;
        }

        .product-points {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .points-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .points-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .points-text {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .original-price {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-decoration: line-through;
        }

        .product-category {
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 0.4rem 0.9rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .exchange-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .exchange-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .exchange-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .exchange-btn.available {
            background: var(--primary-color);
            color: white;
        }

        .exchange-btn.available:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .exchange-btn.disabled {
            background: #e5e7eb;
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        /* Stats & Orders Section */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
            gap: 2rem;
        }

        .stats-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .stats-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stats-title i {
            color: var(--primary-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            transition: transform var(--transition-fast);
        }

        .stat-item:hover {
            transform: translateX(4px);
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-left {
            display: flex;
            flex-direction: column;
        }

        .stat-type {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .stat-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-points {
            text-align: right;
        }

        .stat-points-value {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .stat-points-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .achievement-card {
            text-align: center;
            padding: 1.5rem;
            background: var(--primary-light);
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            transition: transform var(--transition-base);
        }

        .achievement-card:hover {
            transform: scale(1.05);
        }

        .achievement-card:last-child {
            margin-bottom: 0;
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .achievement-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.2rem;
        }

        .achievement-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Leaderboard */
        .leaderboard-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: var(--radius-sm);
            background: var(--primary-light);
            transition: all var(--transition-base);
        }

        .leaderboard-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        .leaderboard-item:last-child {
            margin-bottom: 0;
        }

        .leaderboard-item.current-user {
            background: linear-gradient(135deg, var(--primary-light), rgba(0, 137, 123, 0.15));
            border: 2px solid var(--primary-color);
            transform: scale(1.02);
        }

        .leaderboard-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rank-badge {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #e89b5a); }
        .rank-other { background: var(--primary-color); }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .user-items {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-points {
            text-align: right;
        }

        .user-points-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .user-points-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Orders */
        .order-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            border-left: 4px solid var(--primary-color);
        }

        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .order-card:last-child {
            margin-bottom: 0;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .order-id {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.95rem;
        }

        .order-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .order-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .order-product {
            flex: 1;
        }

        .order-product-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .order-quantity {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .order-points {
            text-align: right;
            flex-shrink: 0;
        }

        .order-points-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #dc2626;
        }

        .order-points-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .modal-error {
            background: #fee2e2;
            border: 2px solid #2b8c3a;
            color: #2b8c3a;
            padding: 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            display: none;
            align-items: flex-start;
            gap: 0.75rem;
            font-weight: 500;
            line-height: 1.5;
        }

        .modal-error.active {
            display: flex;
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .modal-error i {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .order-detail {
            background: var(--primary-light);
            padding: 1.25rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
        }

        .order-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .order-detail-row:last-child {
            margin-bottom: 0;
            padding-top: 0.75rem;
            border-top: 2px solid var(--primary-color);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .order-detail-label {
            color: var(--text-secondary);
        }

        .order-detail-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-note {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        .modal-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 1rem;
        }

        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-btn-confirm {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn-confirm:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        .modal-btn-cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn-cancel:hover {
            background: #d1d5db;
        }

        /* Login Prompt */
        .login-prompt {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .login-prompt.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .login-prompt-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 3rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .login-prompt-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }

        .login-prompt-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .login-prompt-message {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .login-prompt-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .login-prompt-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Floating Button */
        .floating-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 16px rgba(0, 137, 123, 0.4);
            transition: all var(--transition-base);
            z-index: 1000;
        }

        .floating-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.15) rotate(15deg);
        }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-sm);
            z-index: 10001;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            transform: translateX(120%);
            transition: transform var(--transition-smooth);
            font-weight: 500;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            line-height: 1.5;
        }

        .notification-toast.show {
            transform: translateX(0);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                flex-wrap: wrap;
            }

            .header-right {
                gap: 1rem;
            }

            .nav {
                top: auto;
            }

            .nav-item {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }

            .products-grid {
                gap: 1rem;
            }

            .stats-grid {
                gap: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .login-prompt-content {
                padding: 2rem;
            }

            .floating-btn {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .logo-text p {
                display: none;
            }

            .points-label {
                display: none;
            }

            .nav-item span {
                display: none;
            }

            .nav-item {
                padding: 1rem;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
  
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-recycle"></i>
                </div>
                <div class="logo-text">
                    <h1>Á∂†Ëâ≤ÈªûÊï∏ÂïÜÂüé</h1>
                    <p>ÂõûÊî∂ÊèõÈªûÊï∏ÔºåÁ∂†Ëâ≤Êñ∞ÁîüÊ¥ª</p>
                </div>
            </div>
            
            <div class="header-right">
                <div class="points-display">
                    <div class="points-value">
                        <i class="fas fa-award"></i>
                        <span id="userPoints">0</span>
                    </div>
                    <div class="points-label">ÂèØÁî®ÈªûÊï∏</div>
                </div>
                
                <div class="cart-icon" role="button" aria-label="Ë≥ºÁâ©Ëªä">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge hidden" id="cartBadge">0</span>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav" role="navigation">
        <div class="nav-container">
            <div class="nav-item active" data-tab="products" role="button" tabindex="0">
                <i class="fas fa-gift"></i>
                <span>ÂïÜÂìÅÂÖåÊèõ</span>
            </div>
            <div class="nav-item" data-tab="orders" role="button" tabindex="0">
                <i class="fas fa-shopping-bag"></i>
                <span>ÊàëÁöÑË®ÇÂñÆ</span>
            </div>
            <div class="nav-item" data-tab="stats" role="button" tabindex="0">
                <i class="fas fa-chart-line"></i>
                <span>ÂõûÊî∂Áµ±Ë®à</span>
            </div>
            <div class="nav-item" data-tab="leaderboard" role="button" tabindex="0">
                <i class="fas fa-users"></i>
                <span>ÊéíË°åÊ¶ú</span>
            </div>
        </div>
    </nav>

  
    <main class="main-container">
        <section id="products-section" class="section active">
            <div class="category-filter">
                <div class="category-buttons" role="group" aria-label="ÂïÜÂìÅÂàÜÈ°û">
                    <button class="category-btn active" data-category="ÂÖ®ÈÉ®">ÂÖ®ÈÉ®</button>
                    <button class="category-btn" data-category="ÁîüÊ¥ªÁî®ÂìÅ">ÁîüÊ¥ªÁî®ÂìÅ</button>
                    <button class="category-btn" data-category="È§êÂÖ∑">È§êÂÖ∑</button>
                    <button class="category-btn" data-category="ÈõªÂ≠êÁî¢ÂìÅ">ÈõªÂ≠êÁî¢ÂìÅ</button>
                    <button class="category-btn" data-category="ÂúíËóù">ÂúíËóù</button>
                    <button class="category-btn" data-category="ÂÆ∂Áî®">ÂÆ∂Áî®</button>
                    <button class="category-btn" data-category="Ê∏ÖÊΩîÁî®ÂìÅ">Ê∏ÖÊΩîÁî®ÂìÅ</button>
                </div>
            </div>
          
            <div class="products-grid" id="productsGrid" role="list">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

    
        <section id="orders-section" class="section">
            <div class="stats-card">
                <div class="stats-title">
                    <i class="fas fa-shopping-bag"></i>
                    <span>ÊàëÁöÑË®ÇÂñÆ</span>
                </div>
                <div id="ordersContainer"></div>
                <div id="emptyOrders" class="empty-state hidden">
                    <div class="empty-state-icon">üì¶</div>
                    <div class="empty-state-title">ÊÇ®ÈÇÑÊ≤íÊúâ‰ªª‰ΩïË®ÇÂñÆ</div>
                    <div class="empty-state-text">Âø´ÂéªÂïÜÂüéÂÖåÊèõÂïÜÂìÅÂêßÔºÅ</div>
                </div>
            </div>
        </section>

   
        <section id="stats-section" class="section">
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-title">
                        <i class="fas fa-chart-line"></i>
                        <span>Êú¨ÊúàÂõûÊî∂Áµ±Ë®à</span>
                    </div>
                    <div id="recyclingStats"></div>
                </div>

                <div class="stats-card">
                    <div class="stats-title">
                        <i class="fas fa-leaf"></i>
                        <span>Áí∞‰øùÊàêÂ∞±</span>
                    </div>
                    <div class="achievement-card">
                        <div class="achievement-icon">üåç</div>
                        <div class="achievement-value">12.5 kg</div>
                        <div class="achievement-label">Ê∏õÂ∞ëÁ¢≥ÊéíÊîæ</div>
                    </div>
                    <div class="achievement-card">
                        <div class="achievement-icon">üå±</div>
                        <div class="achievement-value">3</div>
                        <div class="achievement-label">ÊãØÊïëÊ®πÊú®</div>
                    </div>
                </div>
            </div>
        </section>


        <section id="leaderboard-section" class="section">
            <div class="leaderboard-card">
                <div class="stats-title">
                    <i class="fas fa-trophy"></i>
                    <span>Êú¨ÊúàÁí∞‰øùËã±ÈõÑÊ¶ú</span>
                </div>
                <div id="leaderboardList"></div>
            </div>
        </section>
    </main>


    <button class="floating-btn" aria-label="ÂõûÊî∂Áâ©ÂìÅ">
        <i class="fas fa-recycle"></i>
    </button>

    <div class="modal-overlay" id="orderModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üõí</div>
                <div class="modal-title" id="modalTitle">Á¢∫Ë™çÂÖåÊèõ</div>
            </div>
            <div class="modal-body">
                <div class="modal-error" id="modalError" role="alert">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="modalErrorMessage"></span>
                </div>
                
                <div class="order-detail">
                    <div class="order-detail-row">
                        <span class="order-detail-label">ÂïÜÂìÅÂêçÁ®±Ôºö</span>
                        <span class="order-detail-value" id="modalProductName"></span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-detail-label">ÂÖåÊèõÊï∏ÈáèÔºö</span>
                        <span class="order-detail-value" id="modalQuantity">1</span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-detail-label">ÊâÄÈúÄÈªûÊï∏Ôºö</span>
                        <span class="order-detail-value" id="modalPoints"></span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-detail-label">Ââ©È§òÈªûÊï∏Ôºö</span>
                        <span class="order-detail-value" id="modalRemainingPoints"></span>
                    </div>
                </div>
                <p class="modal-note">Á¢∫ÂÆöË¶ÅÂÖåÊèõÊ≠§ÂïÜÂìÅÂóéÔºü</p>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Á¢∫Ë™çÂÖåÊèõ</button>
            </div>
        </div>
    </div>


    <div class="login-prompt" id="loginPrompt" role="dialog" aria-modal="true">
        <div class="login-prompt-content">
            <div class="login-prompt-icon">üîí</div>
            <div class="login-prompt-title">Ë´ãÂÖàÁôªÂÖ•</div>
            <div class="login-prompt-message">
                ÊÇ®ÈúÄË¶ÅÁôªÂÖ•ÊâçËÉΩ‰ΩøÁî®Á∂†Ëâ≤ÈªûÊï∏ÂïÜÂüé<br>
                Á´ãÂç≥ÁôªÂÖ•ÈñãÂßãÊÇ®ÁöÑÁí∞‰øù‰πãÊóÖÔºÅ
            </div>
            <a href="dashboard.html" class="login-prompt-btn">
                <i class="fas fa-sign-in-alt"></i>
                <span>ÂâçÂæÄÁôªÂÖ•</span>
            </a>
        </div>
    </div>

    <script>
        'use strict';

        // ========== ÊáâÁî®ÁãÄÊÖãÁÆ°ÁêÜ ==========
        const AppState = {
            API_BASE_URL: '',
            userPoints: 0,
            userId: null,
            username: '',
            activeTab: 'products',
            selectedCategory: 'ÂÖ®ÈÉ®',
            products: [],
            currentProduct: null,
            isLoading: false,
            cache: {
                products: null,
                orders: null,
                stats: null,
                leaderboard: null
            }
        };

        // ========== DOM ÂÖÉÁ¥†Âø´Âèñ ==========
        const DOM = {
            userPoints: null,
            cartBadge: null,
            productsGrid: null,
            ordersContainer: null,
            emptyOrders: null,
            recyclingStats: null,
            leaderboardList: null,
            orderModal: null,
            modalError: null,
            modalErrorMessage: null,
            modalProductName: null,
            modalQuantity: null,
            modalPoints: null,
            modalRemainingPoints: null,
            modalCancelBtn: null,
            modalConfirmBtn: null,
            loginPrompt: null,
            navItems: null,
            categoryBtns: null,
            sections: null
        };

        // ========== ÂàùÂßãÂåñ ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Shop] ÂïÜÂüéÈ†ÅÈù¢ÂàùÂßãÂåñ');
            initializeApp();
        });

        async function initializeApp() {
            try {
                cacheDOMElements();
                setupEventListeners();
                await loadUserData();
            } catch (error) {
                console.error('[Shop] ÂàùÂßãÂåñÂ§±Êïó:', error);
                showNotification('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢', 'error');
            }
        }

        function cacheDOMElements() {
            DOM.userPoints = document.getElementById('userPoints');
            DOM.cartBadge = document.getElementById('cartBadge');
            DOM.productsGrid = document.getElementById('productsGrid');
            DOM.ordersContainer = document.getElementById('ordersContainer');
            DOM.emptyOrders = document.getElementById('emptyOrders');
            DOM.recyclingStats = document.getElementById('recyclingStats');
            DOM.leaderboardList = document.getElementById('leaderboardList');
            DOM.orderModal = document.getElementById('orderModal');
            DOM.modalError = document.getElementById('modalError');
            DOM.modalErrorMessage = document.getElementById('modalErrorMessage');
            DOM.modalProductName = document.getElementById('modalProductName');
            DOM.modalQuantity = document.getElementById('modalQuantity');
            DOM.modalPoints = document.getElementById('modalPoints');
            DOM.modalRemainingPoints = document.getElementById('modalRemainingPoints');
            DOM.modalCancelBtn = document.getElementById('modalCancelBtn');
            DOM.modalConfirmBtn = document.getElementById('modalConfirmBtn');
            DOM.loginPrompt = document.getElementById('loginPrompt');
            DOM.navItems = document.querySelectorAll('.nav-item');
            DOM.categoryBtns = document.querySelectorAll('.category-btn');
            DOM.sections = {
                products: document.getElementById('products-section'),
                orders: document.getElementById('orders-section'),
                stats: document.getElementById('stats-section'),
                leaderboard: document.getElementById('leaderboard-section')
            };
        }

        // ========== Áî®Êà∂Ë™çË≠â ==========
        async function loadUserData() {
            if (AppState.isLoading) return;
            AppState.isLoading = true;

            try {
                console.log('[Shop] ÈñãÂßãËºâÂÖ•Áî®Êà∂Ë≥áÊñô...');
                
                const authResponse = await fetch('/api/check-auth', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!authResponse.ok) {
                    throw new Error(`HTTP error! status: ${authResponse.status}`);
                }

                const authData = await authResponse.json();
                console.log('[Shop] Ë™çË≠âÁµêÊûú:', authData);

                if (!authData.authenticated) {
                    console.warn('[Shop] Áî®Êà∂Êú™ÁôªÂÖ•');
                    handleUnauthenticated();
                    return;
                }

                updateAppState(authData.user);
                localStorage.setItem('userData', JSON.stringify(authData.user));
                localStorage.setItem('currentUser', authData.user.username);
                
                console.log('[Shop] Áî®Êà∂Ë≥áÊñôËºâÂÖ•ÊàêÂäü');
                
                await Promise.all([
                    loadProducts(),
                    loadStatsData(),
                    loadLeaderboardData()
                ]);

            } catch (error) {
                console.error('[Shop] ËºâÂÖ•Áî®Êà∂Êï∏ÊìöÂ§±Êïó:', error);
                handleAuthError(error);
            } finally {
                AppState.isLoading = false;
            }
        }

        function updateAppState(userData) {
            AppState.userId = userData.id;
            AppState.username = userData.username;
            AppState.userPoints = userData.points;
            updatePointsDisplay();
        }

        function handleUnauthenticated() {
            localStorage.clear();
            sessionStorage.clear();
            showLoginPrompt();
        }

        function handleAuthError(error) {
            console.error('[Shop] Ë™çË≠âÈåØË™§:', error);
            showNotification('ËºâÂÖ•Â§±ÊïóÔºåË´ãÈáçÊñ∞ÁôªÂÖ•', 'error');
            setTimeout(() => handleUnauthenticated(), 2000);
        }

        // ========== UI ÊéßÂà∂ ==========
        function showLoginPrompt() {
            if (DOM.loginPrompt) {
                DOM.loginPrompt.classList.add('active');
            }
            
            Object.values(DOM.sections).forEach(section => {
                if (section) section.style.display = 'none';
            });
            
            const floatingBtn = document.querySelector('.floating-btn');
            if (floatingBtn) floatingBtn.style.display = 'none';
        }

        function updatePointsDisplay() {
            if (DOM.userPoints) {
                DOM.userPoints.textContent = AppState.userPoints.toLocaleString();
            }
        }

        // ========== ÂïÜÂìÅÁÆ°ÁêÜ ==========
        async function loadProducts() {
            if (AppState.cache.products) {
                renderProducts();
                return;
            }

            try {
                const response = await fetch('/api/shop/products', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Shop] ÂïÜÂìÅÊï∏Êìö:', result);

                if (result.success && result.data) {
                    AppState.products = result.data.map(p => ({
                        id: p.id,
                        name: p.name,
                        points: p.points_required,
                        originalPrice: p.original_price,
                        image: p.image_emoji,
                        category: p.category,
                        description: p.description,
                        inStock: p.in_stock === 1,
                        rating: parseFloat(p.rating) || 5.0
                    }));
                    AppState.cache.products = AppState.products;
                    renderProducts();
                } else {
                    throw new Error(result.message || 'ËºâÂÖ•ÂïÜÂìÅÂ§±Êïó');
                }
            } catch (error) {
                console.error('[Shop] ËºâÂÖ•ÂïÜÂìÅÂ§±Êïó:', error);
                showNotification('ËºâÂÖ•ÂïÜÂìÅÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                if (DOM.productsGrid) {
                    DOM.productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòî</div><div class="empty-state-title">ËºâÂÖ•Â§±Êïó</div><div class="empty-state-text">Ë´ãÁ®çÂæåÂÜçË©¶</div></div>';
                }
            }
        }

        function renderProducts() {
            if (!DOM.productsGrid) return;

            const filteredProducts = AppState.selectedCategory === 'ÂÖ®ÈÉ®' 
                ? AppState.products 
                : AppState.products.filter(p => p.category === AppState.selectedCategory);

            if (filteredProducts.length === 0) {
                DOM.productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-title">Êö´ÁÑ°ÂïÜÂìÅ</div><div class="empty-state-text">Ê≠§ÂàÜÈ°ûÁõÆÂâçÊ≤íÊúâÂïÜÂìÅ</div></div>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            filteredProducts.forEach(product => {
                fragment.appendChild(createProductCard(product));
            });
            
            DOM.productsGrid.innerHTML = '';
            DOM.productsGrid.appendChild(fragment);
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('role', 'listitem');

            const canExchange = product.inStock && AppState.userPoints >= product.points;
            const buttonClass = canExchange ? 'available' : 'disabled';
            const buttonText = !product.inStock ? 'Êö´ÊôÇÁº∫Ë≤®' : 
                              AppState.userPoints < product.points ? 'ÈªûÊï∏‰∏çË∂≥' : 'Á´ãÂç≥ÂÖåÊèõ';

            card.innerHTML = `
                <div class="product-image" aria-hidden="true">${product.image}</div>
                <div class="product-rating" aria-label="Ë©ïÂàÜ ${product.rating.toFixed(1)} È°ÜÊòü">
                    ${generateStars(product.rating)}
                    <span class="rating-value">(${product.rating.toFixed(1)})</span>
                </div>
                <h3 class="product-name">${escapeHtml(product.name)}</h3>
                <p class="product-description">${escapeHtml(product.description)}</p>
                <div class="product-info">
                    <div class="product-points">
                        <div class="points-row">
                            <i class="fas fa-award" style="color: var(--primary-color);" aria-hidden="true"></i>
                            <span class="points-number">${product.points.toLocaleString()}</span>
                            <span class="points-text">ÈªûÊï∏</span>
                        </div>
                        <div class="original-price">ÂéüÂÉπ $${product.originalPrice.toLocaleString()}</div>
                    </div>
                    <span class="product-category">${escapeHtml(product.category)}</span>
                </div>
                <button class="exchange-btn ${buttonClass}" 
                        data-product-id="${product.id}"
                        ${!canExchange ? 'disabled' : ''}
                        aria-label="${buttonText} ${product.name}">
                    ${buttonText}
                </button>
            `;

            const button = card.querySelector('.exchange-btn');
            if (button && canExchange) {
                button.addEventListener('click', () => openOrderModal(product.id));
            }

            return card;
        }

        function generateStars(rating) {
            const fullStars = Math.floor(rating);
            return Array.from({ length: 5 }, (_, i) => 
                `<i class="fas fa-star star${i < fullStars ? '' : ' empty'}" aria-hidden="true"></i>`
            ).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== Ë®ÇÂñÆÁÆ°ÁêÜ ==========
        function openOrderModal(productId) {
            AppState.currentProduct = AppState.products.find(p => p.id === productId);
            if (!AppState.currentProduct) {
                showNotification('ÂïÜÂìÅ‰∏çÂ≠òÂú®', 'error');
                return;
            }

            if (DOM.modalProductName) DOM.modalProductName.textContent = AppState.currentProduct.name;
            if (DOM.modalQuantity) DOM.modalQuantity.textContent = '1';
            if (DOM.modalPoints) DOM.modalPoints.textContent = `${AppState.currentProduct.points.toLocaleString()} Èªû`;
            if (DOM.modalRemainingPoints) {
                const remaining = AppState.userPoints - AppState.currentProduct.points;
                DOM.modalRemainingPoints.textContent = `${remaining.toLocaleString()} Èªû`;
            }

            hideModalError();
            if (DOM.orderModal) DOM.orderModal.classList.add('active');
        }

        function closeOrderModal() {
            if (DOM.orderModal) DOM.orderModal.classList.remove('active');
            hideModalError();
            AppState.currentProduct = null;
        }

        async function confirmOrder() {
            if (!AppState.currentProduct) {
                showNotification('Ë´ãÈÅ∏ÊìáÂïÜÂìÅ', 'error');
                return;
            }

            if (AppState.userPoints < AppState.currentProduct.points) {
                showModalError('ÈªûÊï∏‰∏çË∂≥ÔºÅÊÇ®ÁõÆÂâçÁöÑÈªûÊï∏‰∏çË∂≥‰ª•ÂÖåÊèõÊ≠§ÂïÜÂìÅ„ÄÇ');
                return;
            }

            if (!DOM.modalConfirmBtn) return;
            
            if (DOM.modalConfirmBtn.disabled) return;
            
            const originalText = DOM.modalConfirmBtn.textContent;
            DOM.modalConfirmBtn.disabled = true;
            DOM.modalConfirmBtn.textContent = 'ËôïÁêÜ‰∏≠...';

            try {
                const response = await fetch('/api/shop/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        productId: AppState.currentProduct.id,
                        quantity: 1
                    })
                });

                const result = await response.json();
                console.log('[Shop] Ë®ÇÂñÆÁµêÊûú:', result);

                if (result.success) {
                    AppState.userPoints = result.data.remainingPoints;
                    
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    userData.points = AppState.userPoints;
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    updatePointsDisplay();
                    closeOrderModal();
                    
                    showNotification(`‚úÖ ÊàêÂäüÂÖåÊèõ ${AppState.currentProduct.name}ÔºÅ`, 'success');
                    
                    AppState.cache.orders = null;
                    renderProducts();
                } else {
                    handleOrderError(result);
                }
            } catch (error) {
                console.error('[Shop] ÂâµÂª∫Ë®ÇÂñÆÂ§±Êïó:', error);
                showModalError('Á∂≤Ë∑ØÈÄ£Êé•Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÁ∂≤Ë∑ØÈÄ£Êé•ÂæåÈáçË©¶„ÄÇ');
                showNotification('ÂÖåÊèõÊàêÂäü', );
            } finally {
                DOM.modalConfirmBtn.disabled = false;
                DOM.modalConfirmBtn.textContent = originalText;
            }
        }

        function handleOrderError(result) {
            const errorMessage = getDetailedErrorMessage(result.message);
            showModalError(errorMessage);
            showNotification(`ÂÖåÊèõÂ§±ÊïóÔºö${result.message || 'Êú™Áü•ÈåØË™§'}`, 'error');
            
            if (result.message && result.message.includes('Êú™ÁôªÂÖ•')) {
                setTimeout(() => handleUnauthenticated(), 2000);
            }
        }

        function showModalError(message) {
            if (DOM.modalErrorMessage) DOM.modalErrorMessage.textContent = message;
            if (DOM.modalError) DOM.modalError.classList.add('active');
        }

        function hideModalError() {
            if (DOM.modalError) DOM.modalError.classList.remove('active');
            if (DOM.modalErrorMessage) DOM.modalErrorMessage.textContent = '';
        }

        function getDetailedErrorMessage(message) {
            if (!message) return 'ÂÖåÊèõÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ';
            
            const errorMap = {
                'ÈªûÊï∏‰∏çË∂≥': '‚ùå ÈªûÊï∏‰∏çË∂≥ÔºÅÊÇ®ÁõÆÂâçÁöÑÈªûÊï∏‰∏çË∂≥‰ª•ÂÖåÊèõÊ≠§ÂïÜÂìÅÔºåË´ãÂÖàÈÄ≤Ë°åÂõûÊî∂‰ª•Áç≤ÂæóÊõ¥Â§öÈªûÊï∏„ÄÇ',
                'insufficient points': '‚ùå ÈªûÊï∏‰∏çË∂≥ÔºÅÊÇ®ÁõÆÂâçÁöÑÈªûÊï∏‰∏çË∂≥‰ª•ÂÖåÊèõÊ≠§ÂïÜÂìÅÔºåË´ãÂÖàÈÄ≤Ë°åÂõûÊî∂‰ª•Áç≤ÂæóÊõ¥Â§öÈªûÊï∏„ÄÇ',
                'Â∫´Â≠ò‰∏çË∂≥': '‚ùå ÂïÜÂìÅÂ∫´Â≠ò‰∏çË∂≥ÔºÅÊ≠§ÂïÜÂìÅÁõÆÂâçÂ∑≤ÂîÆÁΩÑÔºåË´ãÈÅ∏ÊìáÂÖ∂‰ªñÂïÜÂìÅÊàñÁ®çÂæåÂÜçË©¶„ÄÇ',
                'out of stock': '‚ùå ÂïÜÂìÅÂ∫´Â≠ò‰∏çË∂≥ÔºÅÊ≠§ÂïÜÂìÅÁõÆÂâçÂ∑≤ÂîÆÁΩÑÔºåË´ãÈÅ∏ÊìáÂÖ∂‰ªñÂïÜÂìÅÊàñÁ®çÂæåÂÜçË©¶„ÄÇ',
                'ÂïÜÂìÅ‰∏çÂ≠òÂú®': '‚ùå ÂïÜÂìÅ‰∏çÂ≠òÂú®ÔºÅÊ≠§ÂïÜÂìÅÂèØËÉΩÂ∑≤‰∏ãÊû∂ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢„ÄÇ',
                'not found': '‚ùå ÂïÜÂìÅ‰∏çÂ≠òÂú®ÔºÅÊ≠§ÂïÜÂìÅÂèØËÉΩÂ∑≤‰∏ãÊû∂ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢„ÄÇ',
                'Êú™ÁôªÂÖ•': '‚ùå ÁôªÂÖ•ÁãÄÊÖãÂ∑≤ÈÅéÊúüÔºÅË´ãÈáçÊñ∞ÁôªÂÖ•ÂæåÂÜçË©¶„ÄÇ',
                'not logged in': '‚ùå ÁôªÂÖ•ÁãÄÊÖãÂ∑≤ÈÅéÊúüÔºÅË´ãÈáçÊñ∞ÁôªÂÖ•ÂæåÂÜçË©¶„ÄÇ'
            };

            for (const [key, value] of Object.entries(errorMap)) {
                if (message.toLowerCase().includes(key.toLowerCase())) return value;
            }

            return `‚ùå ${message}`;
        }

        // ========== Ë®ÇÂñÆÊ≠∑Âè≤ ==========
        async function loadOrders() {
            if (AppState.cache.orders) {
                renderOrders(AppState.cache.orders);
                return;
            }

            try {
                const response = await fetch('/api/shop/orders', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Shop] Ë®ÇÂñÆÊ≠∑Âè≤:', result);

                if (result.success && result.data && result.data.length > 0) {
                    AppState.cache.orders = result.data;
                    renderOrders(result.data);
                    if (DOM.emptyOrders) DOM.emptyOrders.classList.add('hidden');
                } else {
                    if (DOM.ordersContainer) DOM.ordersContainer.innerHTML = '';
                    if (DOM.emptyOrders) DOM.emptyOrders.classList.remove('hidden');
                }
            } catch (error) {
                console.error('[Shop] ËºâÂÖ•Ë®ÇÂñÆÂ§±Êïó:', error);
                showNotification('ËºâÂÖ•Ë®ÇÂñÆÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        function renderOrders(orders) {
            if (!DOM.ordersContainer) return;
            
            const fragment = document.createDocumentFragment();
            orders.forEach(order => {
                fragment.appendChild(createOrderCard(order));
            });
            
            DOM.ordersContainer.innerHTML = '';
            DOM.ordersContainer.appendChild(fragment);
        }

        function createOrderCard(order) {
            const orderCard = document.createElement('div');
            orderCard.className = 'order-card';
            
            const orderDate = new Date(order.createdAt);
            const formattedDate = orderDate.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            orderCard.innerHTML = `
                <div class="order-header">
                    <div class="order-id">Ë®ÇÂñÆÁ∑®ËôüÔºö${escapeHtml(order.orderId)}</div>
                    <div class="order-date">${formattedDate}</div>
                </div>
                <div class="order-body">
                    <div class="order-product">
                        <div class="order-product-name">${escapeHtml(order.productName)}</div>
                        <div class="order-quantity">Êï∏ÈáèÔºö${order.quantity}</div>
                    </div>
                    <div class="order-points">
                        <div class="order-points-value">-${order.pointsUsed.toLocaleString()}</div>
                        <div class="order-points-label">ÈªûÊï∏</div>
                    </div>
                </div>
            `;
            
            return orderCard;
        }

        // ========== ÂàÜÈ†ÅÂàáÊèõ ==========
        function switchTab(tab) {
            DOM.navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`[data-tab="${tab}"]`);
            if (activeNavItem) activeNavItem.classList.add('active');

            Object.entries(DOM.sections).forEach(([key, section]) => {
                if (section) {
                    section.classList.toggle('active', key === tab);
                }
            });
            
            AppState.activeTab = tab;

            if (tab === 'orders') loadOrders();
        }

        function filterByCategory(category) {
            DOM.categoryBtns.forEach(btn => btn.classList.remove('active'));
            const activeCategoryBtn = document.querySelector(`[data-category="${category}"]`);
            if (activeCategoryBtn) activeCategoryBtn.classList.add('active');

            AppState.selectedCategory = category;
            renderProducts();
        }

        // ========== Áµ±Ë®àÊï∏Êìö ==========
        async function loadStatsData() {
            if (AppState.cache.stats) {
                renderStats(AppState.cache.stats);
                return;
            }

            try {
                console.log('[Shop] ÈñãÂßãËºâÂÖ•Áµ±Ë®àÊï∏Êìö...');
                const response = await fetch('/api/shop/user-recycling-stats', {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('[Shop] Áµ±Ë®àAPIÁãÄÊÖãÁ¢º:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Shop] Áµ±Ë®àÊï∏Êìö:', result);

                if (result.success && result.data && result.data.length > 0) {
                    AppState.cache.stats = result.data;
                    renderStats(result.data);
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊï∏ÊìöÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã
                    console.log('[Shop] ÁÑ°Áµ±Ë®àÊï∏ÊìöÊàñÁµêÊûú‰∏çÊàêÂäü');
                    const emptyStats = [];
                    renderStats(emptyStats);
                    // ÊòæÁ§∫Á©∫Áä∂ÊÄÅÊ∂àÊÅØ
                    if (DOM.recyclingStats) {
                        DOM.recyclingStats.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Êö´ÁÑ°ÂõûÊî∂Ë®òÈåÑ</div>';
                    }
                }
            } catch (error) {
                console.error('[Shop] ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±Êïó:', error);
                showNotification('ËºâÂÖ•Áµ±Ë®àÊï∏ÊìöÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        function renderStats(stats) {
            if (!DOM.recyclingStats) return;
            
            const fragment = document.createDocumentFragment();
            stats.forEach(stat => {
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div class="stat-left">
                        <div class="stat-type">${escapeHtml(stat.type)}</div>
                        <div class="stat-count">${stat.count} ÂÄã</div>
                    </div>
                    <div class="stat-points">
                        <div class="stat-points-value">+${stat.points.toLocaleString()}</div>
                        <div class="stat-points-label">ÈªûÊï∏</div>
                    </div>
                `;
                fragment.appendChild(statItem);
            });
            
            DOM.recyclingStats.innerHTML = '';
            DOM.recyclingStats.appendChild(fragment);
        }

        async function loadLeaderboardData() {
            if (AppState.cache.leaderboard) {
                renderLeaderboard(AppState.cache.leaderboard);
                return;
            }

            try {
                console.log('[Shop] ÈñãÂßãËºâÂÖ•ÊéíË°åÊ¶úÊï∏Êìö...');
                const response = await fetch('/api/shop/leaderboard', {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('[Shop] ÊéíË°åÊ¶úAPIÁãÄÊÖãÁ¢º:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Shop] ÊéíË°åÊ¶úÊï∏Êìö:', result);

                if (result.success && result.data && result.data.length > 0) {
                    AppState.cache.leaderboard = result.data;
                    renderLeaderboard(result.data);
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊï∏ÊìöÔºåÈ°ØÁ§∫Á©∫ÁãÄÊÖã
                    console.log('[Shop] ÁÑ°ÊéíË°åÊ¶úÊï∏ÊìöÊàñÁµêÊûú‰∏çÊàêÂäü');
                    const emptyLeaderboard = [];
                    renderLeaderboard(emptyLeaderboard);
                    // ÊòæÁ§∫Á©∫Áä∂ÊÄÅÊ∂àÊÅØ
                    if (DOM.leaderboardList) {
                        DOM.leaderboardList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Êö´ÁÑ°ÊéíË°åÊ¶úÊï∏Êìö</div>';
                    }
                }
            } catch (error) {
                console.error('[Shop] ËºâÂÖ•ÊéíË°åÊ¶úÂ§±Êïó:', error);
                showNotification('ËºâÂÖ•ÊéíË°åÊ¶úÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        function renderLeaderboard(leaderboard) {
            if (!DOM.leaderboardList) return;
            
            const fragment = document.createDocumentFragment();
            leaderboard.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = `leaderboard-item${user.isCurrentUser ? ' current-user' : ''}`;
                
                const rankClass = user.rank <= 3 ? `rank-${user.rank}` : 'rank-other';
                
                userItem.innerHTML = `
                    <div class="leaderboard-left">
                        <div class="rank-badge ${rankClass}">${user.rank}</div>
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(user.name)}</div>
                            <div class="user-items">ÂõûÊî∂ ${user.items} È†ÖÁâ©ÂìÅ</div>
                        </div>
                    </div>
                    <div class="user-points">
                        <div class="user-points-value">${user.points.toLocaleString()}</div>
                        <div class="user-points-label">ÈªûÊï∏</div>
                    </div>
                `;
                
                fragment.appendChild(userItem);
            });
            
            DOM.leaderboardList.innerHTML = '';
            DOM.leaderboardList.appendChild(fragment);
        }

        // ========== ‰∫ã‰ª∂Áõ£ËÅΩÂô® ==========
        function setupEventListeners() {
            // Â∞éËà™Ê®ôÁ±§
            DOM.navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    if (tab) switchTab(tab);
                });
                
                // ÈçµÁõ§ÊîØÊè¥
                item.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const tab = this.getAttribute('data-tab');
                        if (tab) switchTab(tab);
                    }
                });
            });

            // ÂàÜÈ°ûÊåâÈàï
            DOM.categoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    if (category) filterByCategory(category);
                });
            });

            // Ê®°ÊÖãÊ°ÜÊåâÈàï
            if (DOM.modalCancelBtn) {
                DOM.modalCancelBtn.addEventListener('click', closeOrderModal);
            }

            if (DOM.modalConfirmBtn) {
                DOM.modalConfirmBtn.addEventListener('click', confirmOrder);
            }

            // ÈªûÊìäËÉåÊôØÈóúÈñâÊ®°ÊÖãÊ°Ü
            if (DOM.orderModal) {
                DOM.orderModal.addEventListener('click', function(e) {
                    if (e.target === this) closeOrderModal();
                });
            }

            // ESC ÈçµÈóúÈñâÊ®°ÊÖãÊ°Ü
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && DOM.orderModal && DOM.orderModal.classList.contains('active')) {
                    closeOrderModal();
                }
            });
        }

        // ========== ÈÄöÁü•Á≥ªÁµ± ==========
        function showNotification(message, type = 'success') {
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(notif => notif.remove());

            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            
            const typeConfig = {
                success: { bgColor: 'var(--primary-color)', icon: '‚úÖ' },
                error: { bgColor: '#dc2626', icon: '‚úÖ' },
                warning: { bgColor: '#f59e0b', icon: '‚ö†Ô∏è' },
                info: { bgColor: '#3b82f6', icon: '‚ÑπÔ∏è' }
            };
            
            const config = typeConfig[type] || typeConfig.success;
            
            notification.style.cssText = `
                background: ${config.bgColor};
                color: white;
            `;
            
            notification.innerHTML = `<span>${config.icon}</span><span>${escapeHtml(message)}</span>`;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            
            document.body.appendChild(notification);
            
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
            });
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, 4000);
        }
    </script>
</body>
</html>
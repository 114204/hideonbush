<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAIABLOOM - ç’°ä¿ç‰©å“è¾¨è­˜ç³»çµ±</title>
    
    <!-- TensorFlow.js å’Œ MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: rgb(0, 137, 123);
            --secondary-color: #667eea;
            --accent-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-glass: rgba(255, 255, 255, 0.7);
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #C7D8C4 0%, #A4C3A2 50%, rgb(0, 137, 123));
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 15s infinite linear;
        }

        .shape:nth-child(1) { left: 10%; animation-delay: 0s; font-size: 60px; }
        .shape:nth-child(2) { left: 20%; animation-delay: 2s; font-size: 80px; }
        .shape:nth-child(3) { left: 30%; animation-delay: 4s; font-size: 70px; }
        .shape:nth-child(4) { left: 40%; animation-delay: 6s; font-size: 90px; }
        .shape:nth-child(5) { left: 60%; animation-delay: 8s; font-size: 65px; }
        .shape:nth-child(6) { left: 80%; animation-delay: 10s; font-size: 75px; }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 32px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            font-size: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .ai-status {
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 50px;
            display: inline-block;
            font-size: 0.9rem;
            color: var(--success-color);
            font-weight: 500;
        }

        .ai-status.loading {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            color: var(--warning-color);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .upload-section, .quick-section {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.8s ease-out;
        }

        .upload-section { animation-delay: 0.2s; }
        .quick-section { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--border-radius);
            padding: 48px 24px;
            text-align: center;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.05), rgba(102, 126, 234, 0.05));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(102, 126, 234, 0.1));
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .quick-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .quick-item {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            padding: 20px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .quick-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .quick-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .quick-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .preview-container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 32px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
            animation: fadeInUp 0.8s ease-out;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            object-fit: cover;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            margin: 4px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .btn.secondary {
            background: linear-gradient(135deg, var(--text-secondary), var(--text-primary));
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 48px;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            margin-bottom: 32px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .result-container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.8s ease-out;
        }

        .result-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .result-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .item-result {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .item-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }

        .item-category {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 24px;
            padding: 8px 16px;
            border-radius: 50px;
            background: rgba(0, 212, 170, 0.1);
            color: var(--primary-color);
            font-weight: 500;
            display: inline-block;
            width: 100%;
        }

        .confidence-section {
            margin: 24px 0;
        }

        .confidence-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .confidence-bar {
            background: var(--border-color);
            border-radius: 50px;
            height: 12px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            border-radius: 50px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
        }

        .info-card {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.05), rgba(102, 126, 234, 0.05));
            border: 1px solid rgba(0, 212, 170, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .info-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .debug-info {
            margin-top: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: left;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation">
        <div class="floating-shapes">
            <div class="shape">â™»ï¸</div>
            <div class="shape">ğŸŒ±</div>
            <div class="shape">ğŸŒ</div>
            <div class="shape">ğŸƒ</div>
            <div class="shape">ğŸ’š</div>
            <div class="shape">ğŸ”‹</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <span class="logo-icon"></span>
                <h1>GAIABLOOM AI</h1>
            </div>
            <p class="subtitle">ç’°ä¿ç‰©å“æ™ºèƒ½è¾¨è­˜ç³»çµ±</p>
            <div class="ai-status loading" id="aiStatus">AI æ¨¡å‹è¼‰å…¥ä¸­...</div>
        </header>

        <div class="main-content">
            <section class="upload-section">
                <h2 class="section-title">
                    <span>ğŸ“¸</span>
                    åœ–ç‰‡è¾¨è­˜
                </h2>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸš€</div>
                    <div class="upload-text">æ‹–æ‹½åœ–ç‰‡åˆ°é€™è£¡æˆ–é»æ“Šä¸Šå‚³</div>
                    <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                </div>
            </section>

            <section class="quick-section">
                <h2 class="section-title">
                    <span>âš¡</span>
                    å¿«é€Ÿé¸æ“‡
                </h2>
                
                <div class="quick-grid">
                    <div class="quick-item" onclick="selectQuickItem('plastic_bottle')">
                        <span class="quick-icon">ğŸ¼</span>
                        <div class="quick-label">å¯¶ç‰¹ç“¶</div>
                    </div>
                    <div class="quick-item" onclick="selectQuickItem('aluminum_can')">
                        <span class="quick-icon">ğŸ¥¤</span>
                        <div class="quick-label">é‹ç½</div>
                    </div>
                    <div class="quick-item" onclick="selectQuickItem('glass_bottle')">
                        <span class="quick-icon">ğŸ¾</span>
                        <div class="quick-label">ç»ç’ƒç“¶</div>
                    </div>
                    <div class="quick-item" onclick="selectQuickItem('cardboard')">
                        <span class="quick-icon">ğŸ“¦</span>
                        <div class="quick-label">ç´™ç›’</div>
                    </div>
                    <div class="quick-item" onclick="selectQuickItem('plastic_bag')">
                        <span class="quick-icon">ğŸ›ï¸</span>
                        <div class="quick-label">å¡‘è† è¢‹</div>
                    </div>
                    <div class="quick-item" onclick="selectQuickItem('electronics')">
                        <span class="quick-icon">ğŸ“±</span>
                        <div class="quick-label">é›»å­ç”¢å“</div>
                    </div>
                </div>
            </section>
        </div>

        <div class="preview-container hidden" id="previewContainer">
            <img id="previewImage" class="preview-image" alt="é è¦½åœ–ç‰‡">
            <div>
                <button class="btn" onclick="analyzeImage()" id="analyzeBtn">ğŸ” é–‹å§‹ AI è¾¨è­˜</button>
                <button class="btn secondary" onclick="resetUpload()">ğŸ”„ é‡æ–°é¸æ“‡</button>
            </div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">AI æ­£åœ¨åˆ†æåœ–ç‰‡...</div>
        </div>

        <!-- // åœ¨ HTML ä¸­æ‰¾åˆ°é€™å€‹éƒ¨åˆ†ä¸¦æ›¿æ› -->
<div class="result-container hidden" id="resultContainer">
    <div class="result-header">
        <h2 class="result-title">ğŸ¯ è¾¨è­˜çµæœ</h2>
    </div>
    <div id="resultContent"></div>
    <div style="text-align: center; margin-top: 24px; display: flex; gap: 12px; justify-content: center;">
        <button class="btn" onclick="submitForReview()" style="background: linear-gradient(135deg, #10b981, #059669);">
            ğŸ“¤ æäº¤å¯©æ ¸
        </button>
        <button class="btn secondary" onclick="resetAll()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
</div>
    </div>

    <script>
    // ç’°ä¿ç‰©å“è³‡æ–™åº«
const ecoDatabase = {
    plastic_bottle: {
        name: "å¯¶ç‰¹ç“¶",
        category: "å¡‘è† å®¹å™¨",
        recycleCode: "PET (1è™Ÿ)",
        color: "#4299e1",
        recycleInstructions: "1. æ¸…æ´—ä¹¾æ·¨,å»é™¤æ¨™ç±¤å’Œç“¶è“‹\n2. å£“æ‰æ¸›å°‘é«”ç©\n3. æŠ•å…¥å¡‘è† å›æ”¶æ¡¶(è—è‰²)\n4. å¯å›æ”¶è£½æˆè¡£ç‰©çº–ç¶­æˆ–æ–°å®¹å™¨",
        ecoTips: "é¸æ“‡ç»ç’ƒç“¶è£é£²æ–™,æˆ–ä½¿ç”¨å¯é‡è¤‡ä½¿ç”¨çš„æ°´ç“¶",
        keywords: ['bottle', 'water', 'plastic', 'pop', 'soda', 'beverage', 'drink']
    },
    aluminum_can: {
        name: "é‹ç½",
        category: "é‡‘å±¬å®¹å™¨",
        recycleCode: "é‹ (ALU)",
        color: "#718096",
        recycleInstructions: "1. æ²–æ´—ä¹¾æ·¨å»é™¤æ®˜ç•™ç‰©\n2. å¯å£“æ‰ç¯€çœç©ºé–“\n3. æŠ•å…¥é‡‘å±¬å›æ”¶æ¡¶(é»ƒè‰²)\n4. 100%å¯ç„¡é™æ¬¡å›æ”¶å†åˆ©ç”¨",
        ecoTips: "é‹ç½æ˜¯æœ€ç’°ä¿çš„åŒ…è£é¸æ“‡,å›æ”¶æ•ˆç›Šæ¥µé«˜",
        keywords: ['can', 'aluminum', 'aluminium', 'beer', 'soda', 'pop', 'drink']
    },
    glass_bottle: {
        name: "ç»ç’ƒç“¶",
        category: "ç»ç’ƒå®¹å™¨",
        recycleCode: "ç»ç’ƒ (GL)",
        color: "#38a169",
        recycleInstructions: "1. æ¸…æ´—ä¹¾æ·¨å»é™¤æ¨™ç±¤\n2. å»é™¤é‡‘å±¬ç“¶è“‹\n3. ä¾é¡è‰²åˆ†é¡æŠ•å…¥ç»ç’ƒå›æ”¶æ¡¶\n4. å¯ç„¡é™æ¬¡å›æ”¶ä¸é™å“è³ª",
        ecoTips: "ç»ç’ƒæ˜¯æœ€ç’°ä¿çš„åŒ…è£ææ–™,å»ºè­°å„ªå…ˆé¸æ“‡",
        keywords: ['bottle', 'glass', 'wine', 'beer', 'jar', 'container']
    },
    cardboard: {
        name: "ç´™ç›’/ç´™ç®±",
        category: "ç´™é¡",
        recycleCode: "ç´™é¡ (PAP)",
        color: "#d69e2e",
        recycleInstructions: "1. æ¸…æ´—ä¹¾æ·¨ä¸¦å¼„ä¹¾\n2. æ‹†è§£æ”¤å¹³,å»é™¤è† å¸¶\n3. æŠ•å…¥ç´™é¡å›æ”¶æ¡¶(ç™½è‰²)\n4. å¯è£½æˆå†ç”Ÿç´™æˆ–æ–°ç´™ç›’",
        ecoTips: "é¸æ“‡FSCèªè­‰ç´™ç›’,æ”¯æŒæ°¸çºŒæ—æ¥­ç®¡ç†",
        keywords: ['box', 'cardboard', 'carton', 'package', 'packaging', 'paper']
    },
    plastic_bag: {
        name: "å¡‘è† è¢‹",
        category: "è»Ÿæ€§å¡‘è† ",
        recycleCode: "PE (2/4è™Ÿ)",
        color: "#e53e3e",
        recycleInstructions: "1. æ¸…æ´—ä¹¾æ·¨ä¸¦å®Œå…¨æ™¾ä¹¾\n2. é€è‡³è¶…å•†æˆ–è³£å ´å›æ”¶é»\n3. ä¸å¯æŠ•å…¥ä¸€èˆ¬å›æ”¶æ¡¶\n4. å¯è£½æˆå¡‘è† æœ¨ææˆ–å…¬åœ’è¨­æ–½",
        ecoTips: "ä½¿ç”¨ç’°ä¿è³¼ç‰©è¢‹,æ¸›å°‘ä¸€æ¬¡æ€§å¡‘è† è¢‹ä½¿ç”¨",
        keywords: ['bag', 'plastic', 'shopping', 'grocery', 'carrier']
    },
    electronics: {
        name: "é›»å­ç”¢å“",
        category: "é›»å­å»¢æ£„ç‰©",
        recycleCode: "é›»å­é¡ (WEEE)",
        color: "#f56565",
        recycleInstructions: "1. é€è‡³æŒ‡å®šé›»å­å›æ”¶é»\n2. å°ˆæ¥­æ‹†è§£è™•ç†æœ‰å®³ç‰©è³ª\n3. å›æ”¶ç¨€åœŸé‡‘å±¬å’Œæœ‰åƒ¹ææ–™\n4. é¿å…é‡é‡‘å±¬æ±¡æŸ“ç’°å¢ƒ",
        ecoTips: "å»¶é•·é›»å­ç”¢å“ä½¿ç”¨å£½å‘½,è€ƒæ…®ç¶­ä¿®æˆ–å‡ç´š",
        keywords: ['phone', 'computer', 'laptop', 'tablet', 'electronic', 'device', 'screen', 'monitor', 'keyboard', 'mouse']
    },
    food_waste: {
        name: "å»šé¤˜",
        category: "æœ‰æ©Ÿå»¢æ£„ç‰©",
        recycleCode: "å»šé¤˜",
        color: "#9f7aea",
        recycleInstructions: "1. ç€ä¹¾å¤šé¤˜æ°´åˆ†\n2. å»é™¤åŒ…è£ææ–™\n3. æŠ•å…¥å»šé¤˜å›æ”¶æ¡¶(æ£•è‰²)\n4. å¯è£½æˆå †è‚¥æˆ–ç”Ÿè³ªèƒ½æº",
        ecoTips: "é©é‡æ¡è²·é£Ÿæ,æ¸›å°‘é£Ÿç‰©æµªè²»",
        keywords: ['food', 'waste', 'organic', 'fruit', 'vegetable', 'banana', 'apple', 'orange']
    },
    paper: {
        name: "ç´™é¡",
        category: "ç´™å¼µ",
        recycleCode: "ç´™é¡ (PAP)",
        color: "#d69e2e",
        recycleInstructions: "1. ä¿æŒä¹¾ç‡¥é¿å…æ±¡æŸ“\n2. å»é™¤å¡‘è† æˆ–é‡‘å±¬é…ä»¶\n3. æŠ•å…¥ç´™é¡å›æ”¶æ¡¶\n4. å¯è£½æˆå†ç”Ÿç´™æˆ–è¡›ç”Ÿç´™",
        ecoTips: "é›™é¢ä½¿ç”¨ç´™å¼µ,é¸æ“‡æ•¸ä½åŒ–æ¸›å°‘ç”¨ç´™",
        keywords: ['paper', 'document', 'newspaper', 'magazine', 'book', 'tissue']
    }
};

// å…¨åŸŸè®Šæ•¸
let mobilenetModel = null;
let currentAnalysis = null;
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('previewContainer');
const previewImage = document.getElementById('previewImage');
const loading = document.getElementById('loading');
const loadingText = document.getElementById('loadingText');
const resultContainer = document.getElementById('resultContainer');
const resultContent = document.getElementById('resultContent');
const aiStatus = document.getElementById('aiStatus');
const analyzeBtn = document.getElementById('analyzeBtn');

// è¼‰å…¥ MobileNet æ¨¡å‹
async function loadModel() {
    try {
        aiStatus.textContent = 'AI æ¨¡å‹è¼‰å…¥ä¸­...';
        aiStatus.className = 'ai-status loading';
        
        mobilenetModel = await mobilenet.load();
        
        aiStatus.textContent = 'âœ… AI æ¨¡å‹å·²å°±ç·’';
        aiStatus.className = 'ai-status';
        console.log('MobileNet æ¨¡å‹è¼‰å…¥æˆåŠŸ');
    } catch (error) {
        console.error('æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
        aiStatus.textContent = 'âŒ AI æ¨¡å‹è¼‰å…¥å¤±æ•—';
        aiStatus.className = 'ai-status';
        showNotification('AI æ¨¡å‹è¼‰å…¥å¤±æ•—,è«‹é‡æ–°æ•´ç†é é¢', 'error');
    }
}

// æª”æ¡ˆè™•ç†
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
});

function handleFile(file) {
    if (file.size > 10 * 1024 * 1024) {
        showNotification('æª”æ¡ˆå¤§å°è¶…é 10MB é™åˆ¶', 'error');
        return;
    }

    if (!file.type.startsWith('image/')) {
        showNotification('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.onload = () => showPreview();
    };
    reader.readAsDataURL(file);
}

function showPreview() {
    hideAllSections();
    previewContainer.classList.remove('hidden');
    analyzeBtn.disabled = !mobilenetModel;
    if (!mobilenetModel) {
        showNotification('è«‹ç­‰å¾… AI æ¨¡å‹è¼‰å…¥å®Œæˆ', 'warning');
    }
}

// AI åœ–åƒåˆ†æ
async function analyzeImage() {
    if (!mobilenetModel) {
        showNotification('AI æ¨¡å‹å°šæœªè¼‰å…¥å®Œæˆ', 'warning');
        return;
    }

    hideAllSections();
    loading.classList.remove('hidden');
    loadingText.textContent = 'AI æ­£åœ¨åˆ†æåœ–ç‰‡...';

    try {
        const predictions = await mobilenetModel.classify(previewImage);
        console.log('MobileNet é æ¸¬çµæœ:', predictions);

        currentAnalysis = matchEcoItem(predictions);
        displayResult(currentAnalysis);
    } catch (error) {
        console.error('åˆ†æå¤±æ•—:', error);
        showNotification('åœ–ç‰‡åˆ†æå¤±æ•—,è«‹é‡è©¦', 'error');
        resetUpload();
    }
}

// åŒ¹é…ç’°ä¿ç‰©å“
function matchEcoItem(predictions) {
    let bestMatch = null;
    let highestConfidence = 0;
    let matchedPrediction = null;

    for (const prediction of predictions) {
        const className = prediction.className.toLowerCase();
        const confidence = prediction.probability;

        console.log(`æª¢æŸ¥é æ¸¬: ${prediction.className} (${(confidence * 100).toFixed(2)}%)`);

        for (const [key, item] of Object.entries(ecoDatabase)) {
            const hasMatch = item.keywords.some(keyword => 
                className.includes(keyword.toLowerCase())
            );

            if (hasMatch && confidence > highestConfidence) {
                highestConfidence = confidence;
                bestMatch = { ...item, id: key };
                matchedPrediction = prediction;
            }
        }
    }

    if (!bestMatch && predictions.length > 0) {
        const topPrediction = predictions[0];
        bestMatch = inferEcoItem(topPrediction);
        matchedPrediction = topPrediction;
        highestConfidence = topPrediction.probability;
    }

    return {
        item: bestMatch,
        confidence: highestConfidence,
        predictions: predictions.slice(0, 5),
        matchedPrediction: matchedPrediction
    };
}

// æ™ºèƒ½æ¨æ–·ç’°ä¿ç‰©å“é¡åˆ¥
function inferEcoItem(prediction) {
    const className = prediction.className.toLowerCase();
    
    if (className.includes('bottle') || className.includes('jar')) {
        if (className.includes('wine') || className.includes('beer')) {
            return { ...ecoDatabase.glass_bottle, id: 'glass_bottle' };
        }
        return { ...ecoDatabase.plastic_bottle, id: 'plastic_bottle' };
    }
    
    if (className.includes('banana') || className.includes('orange') || 
        className.includes('apple') || className.includes('fruit') ||
        className.includes('vegetable')) {
        return { ...ecoDatabase.food_waste, id: 'food_waste' };
    }
    
    if (className.includes('phone') || className.includes('computer') || 
        className.includes('laptop') || className.includes('screen') ||
        className.includes('monitor') || className.includes('keyboard')) {
        return { ...ecoDatabase.electronics, id: 'electronics' };
    }
    
    if (className.includes('paper') || className.includes('book') || 
        className.includes('magazine') || className.includes('envelope')) {
        return { ...ecoDatabase.paper, id: 'paper' };
    }
    
    if (className.includes('box') || className.includes('carton') || 
        className.includes('package')) {
        return { ...ecoDatabase.cardboard, id: 'cardboard' };
    }
    
    if (className.includes('bag') || className.includes('plastic')) {
        return { ...ecoDatabase.plastic_bag, id: 'plastic_bag' };
    }
    
    return {
        ...ecoDatabase.plastic_bottle,
        id: 'unknown',
        name: 'æœªçŸ¥ç‰©å“',
        category: 'è«‹äººå·¥ç¢ºèª',
        recycleInstructions: 'å»ºè­°è«®è©¢ç•¶åœ°å›æ”¶ä¸­å¿ƒ',
        ecoTips: 'ç„¡æ³•è‡ªå‹•è­˜åˆ¥,å»ºè­°æ‹æ”æ›´æ¸…æ™°çš„ç…§ç‰‡'
    };
}

// è¨ˆç®—ç©åˆ†çš„å‡½æ•¸
function calculatePoints(analysis) {
    const basePoints = {
        'plastic_bottle': 20,
        'aluminum_can': 30,
        'glass_bottle': 50,
        'cardboard': 20,
        'plastic_bag': 10,
        'electronics': 50,
        'paper': 20,
        'food_waste': 10
    };
    
    return basePoints[analysis.item.id] || 5;
}

// é¡¯ç¤ºè¾¨è­˜çµæœ
function displayResult(analysis) {
    const { item, confidence, predictions, matchedPrediction } = analysis;
    
    const confidencePercent = (confidence * 100).toFixed(1);
    const confidenceLevel = confidence > 0.7 ? 'é«˜' : confidence > 0.4 ? 'ä¸­' : 'ä½';
    
    resultContent.innerHTML = `
        <div class="item-result">
            <div class="item-name" style="color: ${item.color}">
                ${item.name}
            </div>
            <div class="item-category">
                ${item.category} - ${item.recycleCode}
            </div>
            
            <div class="confidence-section">
                <div class="confidence-label">
                    <span>ğŸ¯ AI è¾¨è­˜ä¿¡å¿ƒåº¦</span>
                    <span style="font-weight: 700; color: ${item.color}">${confidencePercent}% (${confidenceLevel})</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-title">â™»ï¸ å›æ”¶æ–¹å¼</div>
                    <div class="info-content">${item.recycleInstructions.replace(/\n/g, '<br>')}</div>
                </div>
                
                <div class="info-card">
                    <div class="info-title">ğŸ’¡ ç’°ä¿å»ºè­°</div>
                    <div class="info-content">${item.ecoTips}</div>
                </div>
            </div>
            
            <div style="margin: 24px 0; text-align: center;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                    å›æ”¶æ•¸é‡:
                </label>
                <input type="number" id="quantityInput" value="1" min="1" max="100" 
                    style="width: 120px; padding: 12px; border: 2px solid var(--border-color); 
                    border-radius: 12px; font-size: 1.1rem; text-align: center; font-weight: 600;">
                <span style="margin-left: 8px; color: var(--text-secondary);">ä»¶</span>
            </div>
            
            <div style="text-align: center; margin: 16px 0;">
                <div style="background: linear-gradient(135deg, #fef3c7, #fcd34d); 
                    padding: 16px 24px; border-radius: 16px; display: inline-block;
                    border: 2px solid #f59e0b;">
                    <span style="color: #92400e; font-weight: 600;">é ä¼°ç²å¾—ç©åˆ†: </span>
                    <span id="estimatedPointsDisplay" style="color: #92400e; font-weight: 700; font-size: 1.5rem;">
                        ${calculatePoints(analysis)}
                    </span>
                    <span style="color: #92400e; font-weight: 600;"> é»</span>
                </div>
            </div>
            
            ${matchedPrediction ? `
                <div class="debug-info">
                    <strong>ğŸ¤– AI è¾¨è­˜è©³æƒ…:</strong><br>
                    è¾¨è­˜ç‚º: ${matchedPrediction.className}<br>
                    ä¿¡å¿ƒåº¦: ${(matchedPrediction.probability * 100).toFixed(2)}%<br>
                    <br>
                    <strong>å…¶ä»–å¯èƒ½çµæœ:</strong><br>
                    ${predictions.map((p, i) => 
                        `${i + 1}. ${p.className} (${(p.probability * 100).toFixed(2)}%)`
                    ).join('<br>')}
                </div>
            ` : ''}
        </div>
    `;
    
    hideAllSections();
    resultContainer.classList.remove('hidden');
    
    const quantityInput = document.getElementById('quantityInput');
    const estimatedPointsDisplay = document.getElementById('estimatedPointsDisplay');
    
    quantityInput.addEventListener('input', () => {
        const quantity = parseInt(quantityInput.value) || 1;
        const basePoints = calculatePoints(analysis);
        const totalPoints = basePoints * quantity;
        estimatedPointsDisplay.textContent = totalPoints;
    });
    
    showNotification(`âœ… æˆåŠŸè¾¨è­˜ç‚ºã€Œ${item.name}ã€`, 'success');
}

async function verifyLoginStatus() {
    console.log('[AI Page] é©—è­‰ç™»å…¥ç‹€æ…‹...');
    
    try {
        // æª¢æŸ¥å¾Œç«¯ session
        const response = await fetch('/api/check-auth', {
            method: 'GET',
            credentials: 'include'
        });
        
        const authData = await response.json();
        console.log('[AI Page] èªè­‰çµæœ:', authData);
        
        if (!authData.authenticated || !authData.user) {
            console.warn('[AI Page] ç”¨æˆ¶æœªç™»å…¥');
            return null;
        }
        
        // æ›´æ–° localStorage
        const userData = authData.user;
        localStorage.setItem('userData', JSON.stringify(userData));
        localStorage.setItem('currentUser', userData.username);
        
        console.log('[AI Page] ç™»å…¥é©—è­‰æˆåŠŸ:', userData);
        return userData;
        
    } catch (error) {
        console.error('[AI Page] é©—è­‰ç™»å…¥ç‹€æ…‹éŒ¯èª¤:', error);
        return null;
    }
}

function showLoginPrompt() {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 32px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        animation: slideUp 0.3s ease-out;
    `;
    
    modal.innerHTML = `
        <div style="color: #ef4444; font-size: 3rem; margin-bottom: 16px;">âŒ</div>
        <h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 12px;">
            è«‹å…ˆç™»å…¥ç³»çµ±
        </h3>
        <p style="color: #6b7280; margin-bottom: 24px; line-height: 1.6;">
            æœªæª¢æ¸¬åˆ°ç™»å…¥ç‹€æ…‹<br><br>
            <strong>å¯èƒ½åŸå› :</strong><br>
            1. å°šæœªç™»å…¥<br>
            2. ç™»å…¥å·²éæœŸ
        </p>
        <p style="color: #6b7280; margin-bottom: 24px;">
            æ˜¯å¦å‰å¾€ç™»å…¥é é¢?
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancelBtn" style="
                padding: 12px 24px;
                border: 2px solid #e5e7eb;
                background: white;
                color: #6b7280;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">å–æ¶ˆ</button>
            <button id="confirmBtn" style="
                padding: 12px 24px;
                border: none;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            ">å‰å¾€ç™»å…¥</button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
        overlay.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => overlay.remove(), 300);
    });
    
    document.getElementById('confirmBtn').addEventListener('click', () => {
        window.location.href = '/login-page';
    });
    
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            overlay.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => overlay.remove(), 300);
        }
    });
    
    if (!document.getElementById('loginPromptStyles')) {
        const style = document.createElement('style');
        style.id = 'loginPromptStyles';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            @keyframes slideUp {
                from { transform: translateY(30px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            #cancelBtn:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
                transform: translateY(-2px);
            }
            #confirmBtn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
            }
        `;
        document.head.appendChild(style);
    }
}

async function submitForReview() {
    console.log('[AI Page] é–‹å§‹æäº¤å¯©æ ¸...');
    
    if (!currentAnalysis) {
        showNotification('è«‹å…ˆå®Œæˆç‰©å“è­˜åˆ¥', 'warning');
        return;
    }

    // é©—è­‰ç™»å…¥ç‹€æ…‹
    const userData = await verifyLoginStatus();
    
    if (!userData || !userData.id || !userData.username) {
        console.error('[AI Page] ç™»å…¥é©—è­‰å¤±æ•—');
        showLoginPrompt();
        return;
    }

    console.log('[AI Page] ç”¨æˆ¶é©—è­‰æˆåŠŸ:', userData);

    // ç²å–æ•¸é‡
    const quantityInput = document.getElementById('quantityInput');
    const quantity = parseInt(quantityInput?.value || '1');
    
    if (quantity < 1 || quantity > 100) {
        showNotification('æ•¸é‡å¿…é ˆåœ¨ 1-100 ä¹‹é–“', 'warning');
        return;
    }

    // è¨ˆç®—ç¸½ç©åˆ†
    const basePoints = calculatePoints(currentAnalysis);
    const totalPoints = basePoints * quantity;

    // æº–å‚™æäº¤æ•¸æ“š
    const reviewData = {
        memberId: userData.id,
        memberName: userData.username,
        itemType: currentAnalysis.item.name,
        itemId: currentAnalysis.item.id,
        quantity: quantity,
        estimatedPoints: totalPoints,
        confidence: currentAnalysis.confidence,
        imageData: previewImage.src,
        aiDetails: currentAnalysis.matchedPrediction ? {
            className: currentAnalysis.matchedPrediction.className,
            probability: currentAnalysis.matchedPrediction.probability
        } : null,
        submitTime: new Date().toISOString(),
        status: 'pending'
    };

    console.log('[AI Page] æäº¤æ•¸æ“š:', reviewData);

    try {
        showNotification('æ­£åœ¨æäº¤å¯©æ ¸...', 'info');
        
        const response = await fetch('/api/recycle/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(reviewData)
        });

        console.log('[AI Page] APIéŸ¿æ‡‰ç‹€æ…‹:', response.status);
        const result = await response.json();
        console.log('[AI Page] APIéŸ¿æ‡‰çµæœ:', result);

        if (response.ok && result.success) {
            showNotification('âœ… æäº¤æˆåŠŸ!å¯©æ ¸ç·¨è™Ÿ: ' + result.reviewId, 'success');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        } else {
            throw new Error(result.message || 'æäº¤å¤±æ•—');
        }
    } catch (error) {
        console.error('[AI Page] æäº¤éŒ¯èª¤:', error);
        showNotification('âŒ æäº¤å¤±æ•—: ' + error.message, 'error');
    }
}


// å¿«é€Ÿé¸æ“‡é …ç›®
function selectQuickItem(itemId) {
    const item = ecoDatabase[itemId];
    if (!item) return;
    
    currentAnalysis = {
        item: { ...item, id: itemId },
        confidence: 1.0,
        predictions: [],
        matchedPrediction: null
    };
    
    displayResult(currentAnalysis);
}

// é‡ç½®ä¸Šå‚³
function resetUpload() {
    fileInput.value = '';
    previewImage.src = '';
    hideAllSections();
    document.querySelector('.main-content').style.display = 'grid';
}

// é‡ç½®å…¨éƒ¨
function resetAll() {
    resetUpload();
    currentAnalysis = null;
}

// éš±è—æ‰€æœ‰å€å¡Š
function hideAllSections() {
    document.querySelector('.main-content').style.display = 'none';
    previewContainer.classList.add('hidden');
    loading.classList.add('hidden');
    resultContainer.classList.add('hidden');
}

// é€šçŸ¥ç³»çµ±
function showNotification(message, type = 'info') {
    const colors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        z-index: 10000;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// æ‹–æ”¾åŠŸèƒ½
const uploadArea = document.querySelector('.upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--secondary-color)';
    uploadArea.style.transform = 'scale(1.02)';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = 'var(--primary-color)';
    uploadArea.style.transform = 'scale(1)';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--primary-color)';
    uploadArea.style.transform = 'scale(1)';
    
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
});

window.addEventListener('load', async () => {
    loadModel();
    
    console.log('[AI Page] é é¢è¼‰å…¥ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹');
    
    const userData = await verifyLoginStatus();
    
    if (!userData) {
        console.warn('[AI Page] æœªæª¢æ¸¬åˆ°æœ‰æ•ˆç™»å…¥è³‡è¨Š');
        
        // é¡¯ç¤ºé ‚éƒ¨æç¤ºæ¢
        const banner = document.createElement('div');
        banner.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #fef3c7, #fcd34d);
            color: #92400e;
            padding: 12px 20px;
            text-align: center;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        `;
        banner.innerHTML = `
            âš ï¸ æ‚¨å°šæœªç™»å…¥ï¼Œè­˜åˆ¥å¾Œå°‡ç„¡æ³•æäº¤å¯©æ ¸ 
            <a href="/login-page" style="color: #00897b; text-decoration: underline; margin-left: 8px;">
                ç«‹å³ç™»å…¥
            </a>
        `;
        document.body.appendChild(banner);
        
        // 5ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
            banner.style.transition = 'all 0.3s ease-out';
            banner.style.transform = 'translateY(-100%)';
            setTimeout(() => banner.remove(), 300);
        }, 5000);
    } else {
        console.log('[AI Page] å·²æª¢æ¸¬åˆ°ç™»å…¥è³‡è¨Š:', userData);
    }
    
    // æ·»åŠ å‹•ç•«æ¨£å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
});

</script>
</body>
</html>

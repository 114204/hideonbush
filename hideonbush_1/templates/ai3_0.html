<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAIABLOOM - ç’°ä¿ç‰©å“è¾¨è­˜ç³»çµ±</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.0"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: rgb(0, 137, 123);
            --secondary: #667eea;
            --success: #10b981;
            --error: #ef4444;
            --text: #1f2937;
            --text-light: #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #C7D8C4 0%, #A4C3A2 50%, rgb(0, 137, 123));
            min-height: 100vh;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }

        header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }

        .content {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            border: 3px dashed var(--primary);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: rgba(0, 137, 123, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: var(--secondary);
            background: rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), #008878);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 137, 123, 0.3); }

        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        #fileInput { display: none; }

        .preview-container, .loading, .result-container { display: none; }

        .preview-container.active, .loading.active, .result-container.active { display: block; }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ai-status {
            padding: 12px 16px;
            background: #f3f3f3;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .card:hover { transform: translateY(-4px); }

        .card-title { font-size: 1.3rem; font-weight: 700; color: #0369a1; margin-bottom: 12px; }

        .card-info { color: var(--text-light); margin-bottom: 16px; font-size: 0.95rem; }

        .card-quantity {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-quantity input {
            width: 60px;
            padding: 8px;
            border: 2px solid #0ea5e9;
            border-radius: 6px;
            font-weight: 600;
        }

        .card-points { font-size: 1.5rem; font-weight: 700; color: #059669; }

        .summary-box {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .summary-box strong { color: #15803d; font-size: 1.3rem; }

        .total-points {
            background: linear-gradient(135deg, #fef3c7, #fcd34d);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }

        .total-points-value { font-size: 2.5rem; font-weight: 800; color: #92400e; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            max-width: 300px;
        }

        .notification.success { border-left: 4px solid var(--success); color: var(--success); }

        .notification.error { border-left: 4px solid var(--error); color: var(--error); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .button-group .btn { flex: 1; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ ç’°ä¿ç‰©å“è¾¨è­˜</h1>
            <p>ä½¿ç”¨ AI æŠ€è¡“å¿«é€Ÿè­˜åˆ¥å›æ”¶ç‰©å“</p>
        </header>

        <div class="content">
            <div class="ai-status" id="aiStatus">ğŸ”„ AI æ¨¡å‹è¼‰å…¥ä¸­...</div>

            <div class="upload-area" id="uploadArea">
                <div style="font-size: 2.5rem; margin-bottom: 12px;">ğŸ“¸</div>
                <p style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">æ‹–æ‹½åœ–ç‰‡æˆ–é»æ“Šä¸Šå‚³</p>
                <p style="font-size: 0.9rem; color: var(--text-light);">æ”¯æŒ JPGã€PNGï¼Œæœ€å¤§ 10MB</p>
            </div>

            <input type="file" id="fileInput" accept="image/*">

            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" alt="Preview">
                <button class="btn" id="analyzeBtn" style="width: 100%;">ğŸ” é–‹å§‹ AI è¾¨è­˜</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingText" style="text-align: center;">æ­£åœ¨åˆ†æåœ–ç‰‡...</p>
            </div>

            <div class="result-container" id="resultContainer">
                <div id="resultContent"></div>
                <div class="button-group">
                    <button class="btn btn-success" id="submitBtn">ğŸš€ æäº¤å›æ”¶æ¸…å–®</button>
                    <button class="btn btn-secondary" id="resetBtn">â†©ï¸ é‡æ–°é–‹å§‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å›æ”¶ç‰©å“è³‡æ–™åº« ====================
        const ecoDatabase = {
            glass_bottle: { name: "ç»ç’ƒç“¶", category: "ç»ç’ƒå®¹å™¨", color: "#38a169", keywords: ['bottle', 'glass', 'cup', 'drinking glass', 'vessel', 'wine glass', 'beer glass', 'wine bottle', 'liquor bottle', 'mason jar', 'jar', 'tumbler', 'goblet', 'glassware', 'vase', 'flask'] },
            plastic_bottle: { name: "å¯¶ç‰¹ç“¶", category: "å¡‘è† å®¹å™¨", color: "#4299e1", keywords: ['bottle', 'plastic', 'water', 'soda', 'pet bottle', 'plastic bottle', 'beverage bottle', 'drink bottle', 'cola', 'sprite', 'disposable', 'plastic container'] },
            aluminum_can: { name: "é‹ç½", category: "é‡‘å±¬å®¹å™¨", color: "#718096", keywords: ['can', 'aluminum', 'beer', 'soda', 'tin', 'metal can', 'energy drink', 'soda can', 'canned', 'beverage can', 'drink can', 'metal'] },
            cardboard: { name: "ç´™ç›’/ç´™ç®±", category: "ç´™é¡", color: "#d69e2e", keywords: ['box', 'cardboard', 'carton', 'corrugated', 'paper box', 'shipping box', 'packaging', 'container', 'board', 'kraft', 'paper', 'corrugated box', 'delivery box'] },
            plastic_bag: { name: "å¡‘è† è¢‹", category: "è»Ÿæ€§å¡‘è† ", color: "#e53e3e", keywords: ['bag', 'plastic', 'shopping bag', 'plastic bag', 'carrier bag', 'pouch', 'sack', 'film', 'wrapper', 'plastic wrap', 'soft plastic'] },
            electronics: { name: "é›»å­ç”¢å“", category: "é›»å­å»¢æ£„ç‰©", color: "#f56565", keywords: ['phone', 'computer', 'laptop', 'monitor', 'mobile', 'smartphone', 'tablet', 'screen', 'keyboard', 'mouse', 'printer', 'motherboard', 'circuit', 'electronic', 'device', 'headphone', 'earphone', 'charger', 'adapter', 'cable'] },
            food_waste: { name: "å»šé¤˜", category: "æœ‰æ©Ÿå»¢æ£„ç‰©", color: "#9f7aea", keywords: ['food', 'fruit', 'vegetable', 'apple', 'banana', 'orange', 'lettuce', 'carrot', 'leaf', 'organic', 'compost', 'fruit waste', 'vegetable waste', 'peeling', 'scraps'] },
            paper: { name: "ç´™å¼µ", category: "ç´™é¡", color: "#d8a566", keywords: ['paper', 'newspaper', 'magazine', 'document', 'sheet', 'flyer', 'brochure', 'booklet', 'envelope', 'printed', 'writing paper', 'cardstock'] },
            metal: { name: "é‡‘å±¬è£½å“", category: "é‡‘å±¬", color: "#6b7280", keywords: ['metal', 'aluminum', 'steel', 'copper', 'brass', 'iron', 'foil', 'metallic', 'tin', 'can', 'scrap metal'] },
            styrofoam: { name: "ä¿éº—é¾", category: "ç™¼æ³¡å¡‘è† ", color: "#fef3c7", keywords: ['styrofoam', 'foam', 'expanded polystyrene', 'eps', 'foam box', 'packing foam', 'insulation foam', 'white foam'] },
            textiles: { name: "ç´¡ç¹”å“", category: "å¸ƒé¡", color: "#d084d0", keywords: ['cloth', 'textile', 'fabric', 'clothing', 'garment', 'apparel', 'shirt', 'pants', 'dress', 'thread', 'rope', 'net'] },
        };

        // ==================== DOM å…ƒç´  ====================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const resultContainer = document.getElementById('resultContainer');
        const resultContent = document.getElementById('resultContent');
        const submitBtn = document.getElementById('submitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const aiStatus = document.getElementById('aiStatus');

        // ==================== æ¨¡å‹ ====================
        let mobilenetModel = null;
        let cocoSsdModel = null;
        let currentAnalysis = null;
        let currentUser = null;

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function hideAll() {
            previewContainer.classList.remove('active');
            loading.classList.remove('active');
            resultContainer.classList.remove('active');
        }

        // ==================== æ¨¡å‹è¼‰å…¥ ====================
        async function loadModels() {
            try {
                aiStatus.textContent = 'ğŸ”„ æ¨¡å‹è¼‰å…¥ä¸­...';
                mobilenetModel = await mobilenet.load();
                cocoSsdModel = await cocoSsd.load();
                aiStatus.textContent = 'âœ… AI æ¨¡å‹å·²å°±ç·’ (MobileNet + COCO-SSD)';
                aiStatus.style.background = '#dcfce7';
                aiStatus.style.color = '#15803d';
            } catch (error) {
                console.error('æ¨¡å‹è¼‰å…¥å¤±æ•—:', error);
                aiStatus.textContent = 'âŒ æ¨¡å‹è¼‰å…¥å¤±æ•—';
                aiStatus.style.background = '#fee2e2';
                aiStatus.style.color = '#991b1b';
            }
        }

        // ==================== æ–‡ä»¶è™•ç† ====================
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--primary)';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file?.type.startsWith('image/')) {
                handleFile(file);
            } else {
                showNotification('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ', 'error');
            }
        });

        function handleFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                showNotification('æª”æ¡ˆå¤§å°è¶…é 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                hideAll();
                previewContainer.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        // ==================== AI åˆ†æ ====================
        analyzeBtn.addEventListener('click', analyzeImage);

        async function analyzeImage() {
            if (!previewImage.src) {
                showNotification('è«‹å…ˆä¸Šå‚³åœ–ç‰‡', 'error');
                return;
            }

            hideAll();
            loading.classList.add('active');

            try {
                const img = document.createElement('img');
                img.src = previewImage.src;
                img.onload = async () => {
                    const [predictions, detections] = await Promise.all([
                        mobilenetModel.classify(img),
                        cocoSsdModel.detect(img)
                    ]);

                    currentAnalysis = matchItems(predictions, detections);
                    hideAll();
                    displayResult(currentAnalysis);
                };
            } catch (error) {
                console.error('åˆ†æå¤±æ•—:', error);
                hideAll();
                showNotification('åˆ†æå¤±æ•—,è«‹é‡è©¦', 'error');
            }
        }

        // ==================== æ ¸å¿ƒæª¢æ¸¬é‚è¼¯ ====================
        function matchItems(predictions, detections) {
            const matched = new Map();

            // ç¬¬ä¸€æ­¥ï¼šæ¿€é€²å»é‡æª¢æ¸¬çµæœ
            let cleanDets = detections
                .filter(d => d.score >= 0.40)  // æé«˜æª¢æ¸¬é–¾å€¼åˆ° 0.40
                .sort((a, b) => b.score - a.score);

            const deduped = [];
            for (const det of cleanDets) {
                let isDup = false;
                for (const existing of deduped) {
                    // æ›´æ¿€é€²çš„å»é‡ï¼š80% é‡ç–Šè¦–ç‚ºåŒä¸€ç‰©é«”
                    if (iouOverlap(det.bbox, existing.bbox) > 0.35) {
                        if (det.score > existing.score) {
                            deduped.splice(deduped.indexOf(existing), 1);
                        } else {
                            isDup = true;
                            break;
                        }
                    }
                }
                if (!isDup) deduped.push(det);
            }

            // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨éƒ½æ˜ å°„åˆ°åŒä¸€å€‹ç‰©å“ï¼ˆå¦‚ç»ç’ƒæ¯ï¼‰
            let allSameType = true;
            let firstType = null;
            for (const det of deduped) {
                const className = det.class.toLowerCase();
                const ecoId = mapToEco(className);
                if (firstType === null) firstType = ecoId;
                if (ecoId !== firstType) {
                    allSameType = false;
                    break;
                }
            }
            
            // å¦‚æœå…¨éƒ¨éƒ½æ˜¯åŒä¸€ç‰©å“é¡å‹ï¼Œåªä¿ç•™ä¿¡å¿ƒåº¦æœ€é«˜çš„ 1 å€‹
            if (allSameType && deduped.length > 1) {
                cleanDets = deduped.slice(0, 1);
            } else {
                // é™åˆ¶æœ€å¤š 3 å€‹æª¢æ¸¬
                cleanDets = deduped.slice(0, 3);
            }

            console.log('ğŸ” æ¸…ç†å¾Œçš„æª¢æ¸¬:', cleanDets.map(d => `${d.class}(${(d.score*100).toFixed(0)}%)`));

            // ç¬¬äºŒæ­¥ï¼šæ˜ å°„æª¢æ¸¬çµæœï¼ˆæ¬Šé‡æ›´é«˜ï¼‰
            for (const det of cleanDets) {
                const className = det.class.toLowerCase();
                const ecoId = mapToEco(className);

                if (ecoId && ecoDatabase[ecoId]) {
                    // æ”¹é€²çš„ä¿¡å¿ƒåº¦è¨ˆç®—ï¼šè€ƒæ…®æª¢æ¸¬åˆ†æ•¸
                    let confidence = Math.min(0.95, det.score * 1.2);
                    
                    matched.set(ecoId, {
                        item: { ...ecoDatabase[ecoId], id: ecoId },
                        score: confidence,
                        source: 'ğŸ“ ç‰©é«”æª¢æ¸¬',
                        detectionScore: det.score
                    });
                }
            }

            // ç¬¬ä¸‰æ­¥ï¼šç”¨åˆ†é¡é©—è­‰å’Œå¢å¼·
            if (predictions.length > 0) {
                const topPred = predictions[0];
                console.log('ğŸ·ï¸ åˆ†é¡çµæœ:', topPred.className, 'ä¿¡å¿ƒåº¦:', (topPred.probability*100).toFixed(1) + '%');
                
                if (topPred.probability >= 0.08) {  // é™ä½åˆ†é¡é–¾å€¼
                    const predClass = topPred.className.toLowerCase();
                    let bestMatch = null;
                    let bestScore = 0;

                    for (const [id, item] of Object.entries(ecoDatabase)) {
                        let score = 0;
                        
                        // ç²¾ç¢ºé—œéµå­—åŒ¹é…
                        for (const keyword of item.keywords) {
                            if (predClass === keyword) {
                                score = Math.min(1, topPred.probability * 1.3);
                                break;
                            }
                        }
                        
                        // åŒ…å«åŒ¹é…
                        if (score === 0) {
                            for (const keyword of item.keywords) {
                                if (predClass.includes(keyword) || keyword.includes(predClass.split(' ')[0])) {
                                    score = Math.min(0.8, topPred.probability * 1.1);
                                    break;
                                }
                            }
                        }
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = id;
                        }
                    }

                    if (bestMatch && bestScore > 0.25) {  // æé«˜åˆ†é¡é–¾å€¼åˆ° 0.25
                        if (matched.has(bestMatch)) {
                            // èåˆæª¢æ¸¬å’Œåˆ†é¡çµæœ
                            const existing = matched.get(bestMatch);
                            existing.score = Math.max(existing.score, bestScore);
                            existing.source = 'ğŸ“ æª¢æ¸¬ + ğŸ·ï¸ åˆ†é¡';
                        } else if (matched.size < 3) {  // æœ€å¤š 3 å€‹çµæœ
                            matched.set(bestMatch, {
                                item: { ...ecoDatabase[bestMatch], id: bestMatch },
                                score: bestScore,
                                source: 'ğŸ·ï¸ åˆ†é¡è­˜åˆ¥',
                                classificationScore: topPred.probability
                            });
                        }
                    }
                }
            }

            // æœ€çµ‚ç¯©é¸ï¼ˆæé«˜æœ€çµ‚ä¿¡å¿ƒåº¦é–¾å€¼ä»¥æé«˜æº–ç¢ºæ€§ï¼‰
            const items = Array.from(matched.values())
                .filter(m => m.score > 0.30)  // æé«˜æœ€çµ‚é–¾å€¼åˆ° 0.30
                .sort((a, b) => b.score - a.score);

            console.log('âœ… æœ€çµ‚æª¢æ¸¬çµæœ:', items.map(m => `${m.item.name}(${(m.score*100).toFixed(0)}%)`));

            return items;
        }

        // IoU è¨ˆç®—
        function iouOverlap(box1, box2) {
            if (!box1 || !box2) return 0;

            const x1_min = box1.x || box1[0], y1_min = box1.y || box1[1];
            const x1_max = x1_min + (box1.width || box1[2]), y1_max = y1_min + (box1.height || box1[3]);

            const x2_min = box2.x || box2[0], y2_min = box2.y || box2[1];
            const x2_max = x2_min + (box2.width || box2[2]), y2_max = y2_min + (box2.height || box2[3]);

            const inter_x_min = Math.max(x1_min, x2_min), inter_y_min = Math.max(y1_min, y2_min);
            const inter_x_max = Math.min(x1_max, x2_max), inter_y_max = Math.min(y1_max, y2_max);

            if (inter_x_max <= inter_x_min || inter_y_max <= inter_y_min) return 0;

            const inter = (inter_x_max - inter_x_min) * (inter_y_max - inter_y_min);
            const union = (x1_max - x1_min) * (y1_max - y1_min) + (x2_max - x2_min) * (y2_max - y2_min) - inter;

            return inter / union;
        }

        // æ˜ å°„åˆ°å›æ”¶ç‰©å“
        function mapToEco(className) {
            const mappings = {
                // ç»ç’ƒå®¹å™¨
                'cup': 'glass_bottle',
                'glass': 'glass_bottle',
                'drinking glass': 'glass_bottle',
                'wine glass': 'glass_bottle',
                'beer glass': 'glass_bottle',
                'wine bottle': 'glass_bottle',
                'liquor bottle': 'glass_bottle',
                'mason jar': 'glass_bottle',
                'jar': 'glass_bottle',
                'tumbler': 'glass_bottle',
                'goblet': 'glass_bottle',
                'vase': 'glass_bottle',
                'glassware': 'glass_bottle',
                'flask': 'glass_bottle',
                
                // å¡‘è† å®¹å™¨
                'bottle': 'plastic_bottle',
                'plastic bottle': 'plastic_bottle',
                'pet bottle': 'plastic_bottle',
                'water': 'plastic_bottle',
                'soda': 'plastic_bottle',
                'cola': 'plastic_bottle',
                'sprite': 'plastic_bottle',
                'beverage': 'plastic_bottle',
                'drink': 'plastic_bottle',
                
                // é‹ç½
                'can': 'aluminum_can',
                'aluminum can': 'aluminum_can',
                'metal can': 'aluminum_can',
                'beer': 'aluminum_can',
                'tin': 'aluminum_can',
                'beverage can': 'aluminum_can',
                
                // ç´™ç®±
                'box': 'cardboard',
                'cardboard': 'cardboard',
                'carton': 'cardboard',
                'corrugated': 'cardboard',
                'paper box': 'cardboard',
                'shipping box': 'cardboard',
                'packaging': 'cardboard',
                
                // å¡‘è† è¢‹
                'bag': 'plastic_bag',
                'plastic bag': 'plastic_bag',
                'shopping bag': 'plastic_bag',
                'film': 'plastic_bag',
                'wrapper': 'plastic_bag',
                
                // é›»å­ç”¢å“
                'phone': 'electronics',
                'computer': 'electronics',
                'laptop': 'electronics',
                'monitor': 'electronics',
                'keyboard': 'electronics',
                'mouse': 'electronics',
                'printer': 'electronics',
                'tablet': 'electronics',
                'screen': 'electronics',
                'smartphone': 'electronics',
                'circuit': 'electronics',
                'headphone': 'electronics',
                'earphone': 'electronics',
                'charger': 'electronics',
                'cable': 'electronics',
                
                // å»šé¤˜
                'food': 'food_waste',
                'fruit': 'food_waste',
                'vegetable': 'food_waste',
                'apple': 'food_waste',
                'banana': 'food_waste',
                'orange': 'food_waste',
                'lettuce': 'food_waste',
                'carrot': 'food_waste',
                'leaf': 'food_waste',
                'vegetable': 'food_waste',
                
                // ç´™å¼µ
                'paper': 'paper',
                'newspaper': 'paper',
                'magazine': 'paper',
                'document': 'paper',
                'flyer': 'paper',
                
                // é‡‘å±¬
                'metal': 'metal',
                'aluminum': 'metal',
                'steel': 'metal',
                'copper': 'metal',
                
                // ä¿éº—é¾
                'styrofoam': 'styrofoam',
                'foam': 'styrofoam',
                'expanded polystyrene': 'styrofoam',
                
                // ç´¡ç¹”å“
                'cloth': 'textiles',
                'textile': 'textiles',
                'fabric': 'textiles',
                'clothing': 'textiles',
                'garment': 'textiles',
            };

            // ç²¾ç¢ºåŒ¹é…ï¼ˆå„ªå…ˆï¼‰
            if (mappings[className]) return mappings[className];
            
            // åŒ…å«åŒ¹é…ï¼ˆå‚™é¸ï¼‰
            for (const [key, id] of Object.entries(mappings)) {
                if (className.includes(key) || key.includes(className)) {
                    return id;
                }
            }
            
            return null;
        }

        // ==================== çµæœé¡¯ç¤º ====================
        function displayResult(items) {
            if (items.length === 0) {
                resultContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 3rem; margin-bottom: 16px;">âŒ</div><div style="font-weight: 600;">ç„¡æ³•è­˜åˆ¥è©²ç‰©å“</div></div>';
            } else {
                let html = `
                    <div class="summary-box">
                        âœ… æª¢æ¸¬åˆ° <strong>${items.length}</strong> ç¨®ç‰©å“<br>
                        <small>${items.map(m => m.item.name).join(' / ')}</small>
                    </div>
                    <div class="grid">
                `;

                let total = 0;
                for (const match of items) {
                    const points = { 
                        glass_bottle: 50, 
                        plastic_bottle: 20, 
                        aluminum_can: 30, 
                        cardboard: 20, 
                        plastic_bag: 10, 
                        electronics: 100,  // æé«˜é›»å­ç”¢å“é»æ•¸
                        food_waste: 5,     // å»šé¤˜è¼ƒå°‘é»æ•¸
                        paper: 15,
                        metal: 40,
                        styrofoam: 15,
                        textiles: 20
                    }[match.item.id] || 15;
                    total += points;

                    html += `
                        <div class="card">
                            <div class="card-title">${match.item.name}</div>
                            <div class="card-info">
                                <div>ğŸ·ï¸ ${match.item.category}</div>
                                <div>ğŸ“Š ä¿¡å¿ƒåº¦: ${(match.score * 100).toFixed(1)}%</div>
                                <div>ğŸ“ ${match.source}</div>
                            </div>
                            <div class="card-quantity">
                                <label>æ•¸é‡:</label>
                                <input type="number" class="qty" value="1" min="1" max="99" data-id="${match.item.id}" data-points="${points}">
                            </div>
                            <div class="card-points">ğŸ’° <span class="pts">${points}</span> åˆ†</div>
                        </div>
                    `;
                }

                html += `</div>
                    <div class="total-points">
                        <div style="color: #92400e; font-weight: 600; margin-bottom: 8px;">ğŸ æœ¬æ¬¡æäº¤ç¸½ç©åˆ†</div>
                        <div class="total-points-value" id="totalPts">${total}</div>
                    </div>
                `;

                resultContent.innerHTML = html;

                document.querySelectorAll('.qty').forEach(input => {
                    input.addEventListener('input', () => {
                        let sum = 0;
                        document.querySelectorAll('.qty').forEach(inp => {
                            sum += parseInt(inp.dataset.points) * (parseInt(inp.value) || 1);
                        });
                        document.getElementById('totalPts').textContent = sum;
                    });
                });
            }

            resultContainer.classList.add('active');
        }

        // ==================== æäº¤ ====================
        submitBtn.addEventListener('click', async () => {
            if (!currentAnalysis || currentAnalysis.length === 0) {
                showNotification('æ²’æœ‰å¯æäº¤çš„ç‰©å“', 'error');
                return;
            }

            // é©—è­‰ç™»å…¥ä¸¦ç²å–ç”¨æˆ¶ä¿¡æ¯
            try {
                const authResponse = await fetch('/api/check-auth', { credentials: 'include' });
                const auth = await authResponse.json();
                
                if (!auth.authenticated) {
                    showNotification('âŒ è«‹å…ˆç™»å…¥', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
                
                // æ­£ç¢ºç²å–ç”¨æˆ¶å°è±¡ï¼Œæ”¯æŒå¤šç¨®è¿”å›æ ¼å¼
                currentUser = auth.user || auth;
                
                // é©—è­‰å¿…è¦çš„ç”¨æˆ¶æ•¸æ“š
                if (!currentUser.id) {
                    showNotification('âŒ ç„¡æ³•ç²å–ç”¨æˆ¶ä¿¡æ¯ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                    return;
                }
            } catch (e) {
                console.error('ç™»å…¥é©—è­‰å¤±æ•—:', e);
                showNotification('âŒ ç™»å…¥é©—è­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ æäº¤ä¸­...';

            try {
                // éæ­·æ¯å€‹æª¢æ¸¬åˆ°çš„ç‰©å“ä¸¦æäº¤
                let successCount = 0;
                let failCount = 0;
                const submitPromises = [];
                const failedItems = [];

                document.querySelectorAll('.qty').forEach((input) => {
                    const itemId = input.dataset.id;
                    const quantity = parseInt(input.value) || 1;
                    const points = parseInt(input.dataset.points) * quantity;

                    // æ‰¾åˆ°å°æ‡‰çš„ç‰©å“ä¿¡æ¯
                    const itemMatch = currentAnalysis.find(m => m.item.id === itemId);
                    if (!itemMatch) {
                        console.warn(`æ‰¾ä¸åˆ°ç‰©å“ ID: ${itemId}`);
                        return;
                    }

                    // è¨ˆç®—ç½®ä¿¡åº¦ï¼Œç¢ºä¿åœ¨ 0-1 ç¯„åœå…§ï¼ˆDECIMAL(5,4) æœ€å¤§ 9.9999ï¼‰
                    let confidence = Math.max(0, Math.min(1, itemMatch.score));
                    confidence = parseFloat(confidence.toFixed(4));

                    // æ§‹å»ºå®Œæ•´çš„ AI è©³æƒ…
                    const aiDetails = {
                        detectionMethod: itemMatch.source || 'ç‰©é«”æª¢æ¸¬',
                        confidence: confidence,
                        detectionScore: itemMatch.detectionScore || confidence,
                        timestamp: new Date().toISOString(),
                        imageInfo: {
                            uploadedAt: new Date().toISOString(),
                            size: 'preview' // è¡¨ç¤ºç‚ºé è¦½åœ–
                        }
                    };

                    const submitData = {
                        memberId: currentUser.id,
                        memberName: currentUser.username || 'Unknown',
                        itemType: itemMatch.item.name,
                        itemId: itemId,
                        quantity: quantity,
                        estimatedPoints: points,
                        confidence: confidence,
                        aiDetails: aiDetails,
                        imageData: previewImage.src || '', // åŒ…å«åœ–ç‰‡æ•¸æ“š URL
                        submitTime: new Date().toISOString()
                    };

                    const submitPromise = fetch('/api/recycle/submit', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(submitData)
                    }).then(async (res) => {
                        if (res.ok) {
                            successCount++;
                            console.log(`âœ… æäº¤æˆåŠŸ: ${itemMatch.item.name}`);
                        } else {
                            const errorData = await res.json().catch(() => ({}));
                            failCount++;
                            failedItems.push({
                                item: itemMatch.item.name,
                                status: res.status,
                                message: errorData.message || 'æœªçŸ¥éŒ¯èª¤'
                            });
                            console.error(`âŒ æäº¤å¤±æ•—: ${itemMatch.item.name} (${res.status})`, errorData);
                        }
                    }).catch(e => {
                        failCount++;
                        failedItems.push({
                            item: itemMatch.item.name,
                            message: e.message || 'ç¶²çµ¡éŒ¯èª¤'
                        });
                        console.error(`âŒ ç¶²çµ¡éŒ¯èª¤: ${itemMatch.item.name}`, e);
                    });

                    submitPromises.push(submitPromise);
                });

                if (submitPromises.length === 0) {
                    showNotification('âŒ æ²’æœ‰æœ‰æ•ˆçš„ç‰©å“å¯ä»¥æäº¤', 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸš€ æäº¤å›æ”¶æ¸…å–®';
                    return;
                }

                // ç­‰å¾…æ‰€æœ‰è«‹æ±‚å®Œæˆ
                await Promise.all(submitPromises);

                if (failCount === 0 && successCount > 0) {
                    showNotification(`âœ… ${successCount} ä»¶ç‰©å“æäº¤æˆåŠŸï¼`, 'success');
                    setTimeout(() => window.location.href = '/dashboard', 1500);
                } else if (successCount > 0 && failCount > 0) {
                    showNotification(`âš ï¸ éƒ¨åˆ†æäº¤æˆåŠŸ: ${successCount} ä»¶æˆåŠŸ, ${failCount} ä»¶å¤±æ•—`, 'error');
                    console.error('å¤±æ•—è©³æƒ…:', failedItems);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸš€ æäº¤å›æ”¶æ¸…å–®';
                } else {
                    showNotification(`âŒ æäº¤å¤±æ•—: æ‰€æœ‰ ${failCount} ä»¶ç‰©å“éƒ½æœªèƒ½æäº¤`, 'error');
                    console.error('æ‰€æœ‰å¤±æ•—è©³æƒ…:', failedItems);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸš€ æäº¤å›æ”¶æ¸…å–®';
                }
            } catch (e) {
                console.error('æäº¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', e);
                showNotification('âŒ æäº¤å¤±æ•—: ' + e.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ æäº¤å›æ”¶æ¸…å–®';
            }
        });

        resetBtn.addEventListener('click', () => {
            hideAll();
            fileInput.value = '';
            currentAnalysis = null;
        });

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', loadModels);
    </script>
</body>
</html>
